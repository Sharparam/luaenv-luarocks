#!/bin/sh
# Install luarocks for luaenv.

if [ -z "$LUAENV_ROOT" ]; then
  LUAENV_ROOT="${HOME}/.luaenv"
fi

if [ -z "${TARBALL_CACHE_PATH}" ] && [ -d "${LUAENV_ROOT}/cache" ]; then
  export TARBALL_CACHE_PATH="${LUAENV_ROOT}/cache"
fi

download() {
  local url="$1"
  local filename="$2"
  [ -n "$url" ] || [ -n "$filename" ] || return 1
  local cached_filename="$TARBALL_CACHE_PATH/$filename"

   && return 0

  if ![-e "$cached_filename"]; then
    if type aria2c >/dev/null 2>&1; then
      aria2c -x5 -k1m --summary-interval=0 -o "$cached_filename" "$url"
    elif type curl >/dev/null 2>&1; then
      curl -qsS -o "$cached_filename" "$url"
    elif type wget >/dev/null 2>&1; then
      wget -nv -O "$cached_filename" "$url"
    else
      echo "error: please install \`aria2c\` or \`curl\` or \`wget\` and try again" >&2
      exit 1
    fi
  fi
  ln -s "$cached_filename" "$filename" >&4 2>&1 || return 1
}


fetch_tarball() {
  local package_name="$1"
  local package_url="$2"

  local package_filename="${package_name}.tar.gz"
  download "$package_url" "$package_filename"

  { tar xzvf "$package_filename"
    rm -f "$package_filename"
  } >&4 2>&1
}

symlink_tarball_from_cache() {
  [ -n "$TARBALL_CACHE_PATH" ] || return 1

  local package_filename="$1"
  local cached_package_filename="${TARBALL_CACHE_PATH}/$package_filename"
  local checksum="$2"

  [ -e "$cached_package_filename" ] || return 1
  verify_checksum "$cached_package_filename" "$checksum" >&4 2>&1 || return 1
  ln -s "$cached_package_filename" "$package_filename" >&4 2>&1 || return 1
}

download_tarball() {
  local package_url="$1"
  [ -n "$package_url" ] || return 1

  local package_filename="$2"
  local checksum="$3"

  echo "-> $package_url" >&2

  { http get "$package_url" > "$package_filename"
    #verify_checksum "$package_filename" "$checksum"
  } >&4 2>&1 || return 1

  if [ -n "$TARBALL_CACHE_PATH" ]; then
    local cached_package_filename="${TARBALL_CACHE_PATH}/$package_filename"
    { mv "$package_filename" "$cached_package_filename"
      ln -s "$cached_package_filename" "$package_filename"
    } >&4 2>&1 || return 1
  fi
}

fetch_git() {
  local package_name="$1"
  local git_url="$2"
  local git_ref="$3"

  echo "Cloning ${git_url}..." >&2

  if type git &>/dev/null; then
    git clone --recursive --depth 1 --branch "$git_ref" "$git_url" "${package_name}" >&4 2>&1
  else
    echo "error: please install \`git\` and try again" >&2
    exit 1
  fi
}

install() {
  printf "install luarocks for $1..."
  local ROOT=`luaenv root`
  local PREFIX=$ROOT/versions/$1
  local HEADER=`find $PREFIX/include -name lua.h`
  local INC=`dirname $HEADER`
  local BIN=$PREFIX/bin

  ./configure --prefix=$PREFIX --with-lua-bin=$BIN --with-lua-include=$INC --force-config >/dev/null

  if [ $? -ne 0 ]; then
    printf "\e[31merror: configure luarocks\e[0m\n"
    exit
  fi

  make build >/dev/null
  if [ $? -ne 0 ]; then
    printf "\e[31merror: build luarocks\e[0m\n"
    exit
  fi

  make install >/dev/null
  if [ $? -ne 0 ]; then
    printf "\e[31merror: install luarocks\e[0m\n"
    exit
  else
    printf "\e[32mok\e[0m\n"
  fi
}


main() {
  case $1 in
    all)
      for version in `luaenv whence lua`; do
        install $version
      done
      ;;

    *.*)
      for version in `luaenv whence lua`; do
        if [ $version == $1 ] ; then
          install $version
          exit
        fi
      done
      printf "\e[1mError: version \e[31m$1\e[0m \e[1mnot found.\e[0m\n"
      exit
      ;;

    *)
      echo "Usage: luaenv-rocks [<version>|all]"
      echo ""
      echo "Install luarocks for your Lua installtion in luaenv."
      echo ""
      echo "<version>: install for specified version only"
      echo "           (same version strings as used in luaenv)."
      echo "      all: install luarocks for all is the lua versions"
      echo "           installed in luaenv."
      exit
      ;;
  esac
}

#main $1

fetch_tarball "luarocks-2.4.1" "https://keplerproject.github.io/luarocks/releases/luarocks-2.4.1.tar.gz"
